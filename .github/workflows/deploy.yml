name: Deploy Backend to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: MYSQL_PASSWORD,JWT_SECRET,GEMINI_API_KEY,STRIPE_API_KEY
          script: |
            set -e
            
            echo "ðŸš€ Site Duyuru Backend Deployment BaÅŸlÄ±yor..."
            
            # ========================================
            # 1. MySQL Kurulumu ve YapÄ±landÄ±rmasÄ±
            # ========================================
            if ! command -v mysql &> /dev/null; then
              echo "ðŸ“¦ MySQL kuruluyor..."
              sudo apt update
              sudo apt install -y mysql-server
              sudo systemctl start mysql
              sudo systemctl enable mysql
              
              # MySQL veritabanÄ± ve kullanÄ±cÄ± oluÅŸtur
              sudo mysql -e "CREATE DATABASE IF NOT EXISTS siteduyuru_db;"
              sudo mysql -e "CREATE USER IF NOT EXISTS 'siteduyuru'@'localhost' IDENTIFIED BY '${{ secrets.MYSQL_PASSWORD }}';"
              sudo mysql -e "GRANT ALL PRIVILEGES ON siteduyuru_db.* TO 'siteduyuru'@'localhost';"
              sudo mysql -e "FLUSH PRIVILEGES;"
              echo "âœ… MySQL kurulumu tamamlandÄ±!"
            else
              echo "âœ… MySQL zaten kurulu"
            fi
            
            # ========================================
            # 2. Java 17 Kurulumu
            # ========================================
            if ! command -v java &> /dev/null; then
              echo "ðŸ“¦ Java 17 kuruluyor..."
              sudo apt update
              sudo apt install -y openjdk-17-jdk
              echo "âœ… Java kurulumu tamamlandÄ±!"
            else
              echo "âœ… Java zaten kurulu: $(java -version 2>&1 | head -n 1)"
            fi
            
            # ========================================
            # 3. Proje Klonlama / GÃ¼ncelleme
            # ========================================
            PROJECT_DIR="/home/ubuntu/siteprojesi"
            
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ðŸ“¥ Proje klonlanÄ±yor..."
              cd /home/ubuntu
              git clone https://github.com/omerdikmen13/siteprojesi.git
            fi
            
            cd $PROJECT_DIR
            git reset --hard HEAD
            git pull origin main
            
            # ========================================
            # 4. Environment DosyasÄ± OluÅŸtur
            # ========================================
            cd SiteDuyuruSistemi
            cat > .env << 'ENVEOF'
            MYSQL_USERNAME=siteduyuru
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            STRIPE_API_KEY=${{ secrets.STRIPE_API_KEY }}
            SPRING_PROFILES_ACTIVE=prod
            ENVEOF
            
            # ========================================
            # 5. Maven Build
            # ========================================
            echo "ðŸ”¨ Maven build baÅŸlÄ±yor..."
            chmod +x mvnw
            ./mvnw clean package -DskipTests -Dspring.profiles.active=prod
            
            # ========================================
            # 6. Systemd Servisi (7/24 Ã‡alÄ±ÅŸma)
            # ========================================
            echo "âš™ï¸ Systemd servisi yapÄ±landÄ±rÄ±lÄ±yor..."
            sudo tee /etc/systemd/system/site-duyuru.service > /dev/null << 'EOF'
            [Unit]
            Description=Site Duyuru Java Backend
            After=network.target mysql.service
            Wants=mysql.service

            [Service]
            User=ubuntu
            WorkingDirectory=/home/ubuntu/siteprojesi/SiteDuyuruSistemi
            Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
            Environment="MYSQL_USERNAME=siteduyuru"
            Environment="MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}"
            Environment="JWT_SECRET=${{ secrets.JWT_SECRET }}"
            Environment="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}"
            Environment="STRIPE_API_KEY=${{ secrets.STRIPE_API_KEY }}"
            Environment="SPRING_PROFILES_ACTIVE=prod"
            ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod target/SiteDuyuruSistemi-0.0.1-SNAPSHOT.jar
            Restart=always
            RestartSec=10
            StandardOutput=journal
            StandardError=journal

            [Install]
            WantedBy=multi-user.target
            EOF

            # ========================================
            # 7. Servisi BaÅŸlat
            # ========================================
            echo "ðŸ”„ Servis baÅŸlatÄ±lÄ±yor..."
            sudo systemctl daemon-reload
            sudo systemctl enable site-duyuru
            sudo systemctl restart site-duyuru
            
            # KÄ±sa bekleme ve durum kontrolÃ¼
            sleep 5
            
            echo ""
            echo "============================================"
            echo "âœ… Backend Deployment BaÅŸarÄ±yla TamamlandÄ±!"
            echo "============================================"
            echo "ðŸ“Œ Servis Durumu:"
            sudo systemctl status site-duyuru --no-pager || true
            echo ""
            echo "ðŸ“Œ Port KontrolÃ¼:"
            sudo netstat -tlnp | grep 8080 || echo "Port henÃ¼z aÃ§Ä±lmadÄ±, biraz bekleyin..."
            echo ""
            echo "ðŸ“Œ LoglarÄ± gÃ¶rmek iÃ§in: sudo journalctl -u site-duyuru -f"
